# fsck

---



## 目录

[TOC]



## 总揽

Linux fsck (英文全拼: file system check) 命令用于检查与修复 Linux 文件系统, 可以同时检查一个或多个 Linux 文件系统.

检查文件系统并尝试修复错误.



## 语法

```shell
fsck [选项] [文件系统]
fsck [-sACVRP] [-t fstype] [--] [fsck-options] filesys [...]
```

**参数**:

- filesys ： device 名称(eg./dev/sda1)，mount 点 (eg. / 或 /usr)
- -t : 给定档案系统的型式，若在 /etc/fstab 中已有定义或 kernel 本身已支援的则不需加上此参数
- -s : 依序一个一个地执行 fsck 的指令来检查
- -A : 对/etc/fstab 中所有列出来的 partition 做检查
- -C : 显示完整的检查进度
- -d : 列印 e2fsck 的 debug 结果
- -p : 同时有 -A 条件时，同时有多个 fsck 的检查一起执行
- -R : 同时有 -A 条件时，省略 / 不检查
- -V : 详细显示模式
- -a : 如果检查有错则自动修复
- -r : 如果检查有错则由使用者回答是否修复

 -a：自动修复文件系统，不询问任何问题；
 -A：依照``/etc/fstab``配置文件的内容，检查文件内所列的全部文件系统；
 -N：不执行指令，仅列出实际执行会进行的动作；
 -P：当搭配``"-A"``参数使用时，则会同时检查所有的文件系统；
 -r：采用互动模式，在执行修复时询问问题，让用户得以确认并决定处理方式；
 -R：当搭配``"-A"``参数使用时，则会略过/目录的文件系统不予检查；
 -s：依序执行检查作业，而非同时执行；
 -t<文件系统类型>：指定要检查的文件系统类型；
 -T：执行``fsck``指令时，不显示标题信息；
 -V：显示指令执行过程。



## 注意

注意：千万不能在运行的系统上面直接执行fsck，特别是RHEL6.0以下ext3的文件系统，否则100%损坏根文件系统，使用fsck -y /dev/sdb1 修复磁盘时，必须将sdb1分区umount掉

特别说明：在EXT3（实际上其他文件系统也类似）无法mount，或者提示fsck时，如果有重要数据，应该慎重对待，千万不可贸然执行"fsck -f -y　"这样的自动修复功能。如果可能，先对故障区域做dd全镜像后再执行，或者以只读方式执行，并仔细看修复过程，如果提示大量inode错误、需要重建树、或大小不对等就不可再继续下去了。

### Linux ext3 fsck一定要慎用

不管是哪种文件系统，其根本目的都是相同的：如何把文件存在系统给定的区域里，如何有效地[管理文件](https://www.baidu.com/s?wd=管理文件&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd)的读与写。为实现这样的目的，驱动层需要完善、周密地应付附加在文件系统上的各种操作。这些操作通常不会是一条指令完成的，如果一个过程需要多条指令完成，在执行这些操作时，全部指令未完成的情况下产生中断，那这个文件系统便会出现一致性错误(或者叫连续性错误)。

为了保证尽可以少的出现一致性错误，现在主流的文件系统都会设计成日志型的。日志型文件系统的主要特点就是把一个操作的所有指令执行过程都另外缓冲下来，如果全部执行完成再清除日志标志，如果操作没有执行完成，可以在重新激活后通过日志回溯或继续完成。

EXT3的日志功能通过在EXT2的设计基础上增加一个特殊的文件(通常是８号节点文件)，在这个文件中记录文件系统的操作过程。但EXT系统文件系统本身在节点、间接索引块、目录节点方面没有冗余保护，所以当文件系统除日志外的其他结构并不一致，却又要通过fsck来进行修复，这种一致性有可能将原本正确的结构也错误化。(就像原来是1+2=3，现在错成了1+3=3，也许改完后变成了1+3=4，就完全没办法还原成最早的1+2=3)。

数据恢复领域经常会遇到这类情况：一次RAID出故障后，下次启动系统提示做fsck，但做完后，也无法mount分区或者mount 分区后数据全是错的。需要对这类情况进行数据修复的难度是很大的，从一个完整的结构(fsck后实际上从系统角度看已经是完整的了)再构建另一个完全不同的结构要比修正一个错误的结构更难以下手。其实这类情况，很多是因为[RAID5](https://www.baidu.com/s?wd=RAID5&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd)有早离线的盘加入了两个逻辑磁盘组，导致所有的数据流是以新+旧的方式交错组成的，自然会有太多错误。这时候如果做fsck后，有可能数据都无法恢复了。

所以，在EXT3（实际上其他文件系统也类似）无法mount，或者提示fsck时，如果有重要数据，应该慎重对待，千万不可贸然执行"fsck -f -y　"这样的自动修复功能。如果可能，先对故障区域做dd全镜像后再执行，或者以只读方式执行，并仔细看修复过程，如果提示大量inode错误、需要重建树、或大小不对等就不可再继续下去了。

补充说明：当文件系统发生错误四化，可用fsck指令尝试加以修复。
注意：千万不能在运行的系统上面直接执行fsck，特别是RHEL6.0以下ext3的文件系统，
   否则100%损坏根文件系统，使用fsck -y /dev/sdb1 修复磁盘时，必须将sdb1分区umount掉

fdisk -l 查看设备号
运行 fsck -y /dev/sdb1 修复磁盘 -y参数为自动确认修复
这条命令也是用fsck修复磁盘是，常使用的命令

特别说明：在EXT3（实际上其他文件系统也类似）无法mount，或者提示fsck时，如果有重要数据，应该慎重对待，千万不可贸然执行"fsck -f -y　"这样的自动修复功能。如果可能，先对故障区域做 dd 全镜像后再执行，或者以只读方式执行，并仔细看修复过程，如果提示大量inode错误、需要重建树、或大小不对等就不可再继续下去了。



## 实例

检查 msdos 档案系统的 /dev/hda5 是否正常，如果有异常便自动修复 :

```
fsck -t msdos -a /dev/hda5
```

只能用fsck 检测并自动修复磁盘了， 提示的/dev/sda3这个分区文件系统出问题了，需要修复，那么就直接修复该分区就可以了。

运行fsck执行修复，-f表示对没有错误的文件强制检查，-y表示自动执行修复。

 fsck -f-y/dev/sda3
修复时间可能有点长，耐心等待。由分区的大小决定时间长短 。

```shell
例：检查磁盘分区/dev/sda5的文件系统。
[root@rhel ~]# fsck /dev/sda5
例：强制检查磁盘分区/dev/sda5的文件系统
[root@rhel~]# fsck -f /dev/sda5
fsckfrom util-linux-ng 2.17.2
e2fsck1.41.12 (17-May-2010)
第一步:检查inode,块,和大小
第二步:检查目录结构
第3步:检查目录连接性
Pass4: Checking reference counts
第5步:检查簇概要信息
/dev/sda5:12/6561792 files (0.0% non-contiguous), 459863/26215641 blocks
例：检查和修复磁盘分区/dev/sda5的文件系统，在执行修复时进行询问，让用户决定处理方式，显示详细修复过程。
    [root@rhel ~]# fsck -rV -t ext4 /dev/sda5
例：检查磁盘分区/dev/sda5的文件系统，并显示完整的检查进度。
[root@rhel ~]# fsck -C -t ext4/dev/sda5
例：检查磁盘分区/dev/sda6的msdos文件系统的是否正常，如果有异常便自动修复。
[root@rhel ~]# fsck -t msdos -a/dev/sda6
```



## See Also

https://www.cnblogs.com/machangwei-8/p/10353614.html